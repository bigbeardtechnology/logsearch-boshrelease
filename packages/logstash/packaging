#!/usr/bin/env bash

set -e -u

RAKE_VERSION=$(find ruby -maxdepth 1 -name 'rake-*' | sed 's/ruby\/rake-\(.*\)\.gem/\1/' | head -1)

# shellcheck disable=1090
source "${BOSH_PACKAGES_DIR:-/var/vcap/packages}/ruby-2.4-r5/bosh/compile.env"

gem install "ruby/rake-${RAKE_VERSION}.gem" --local --no-ri --no-rdoc

# shellcheck disable=1091
source /var/vcap/packages/openjdk-8/bosh/compile.env

tar xzf logstash/logstash-6.8.23.tar.gz -C "${BOSH_INSTALL_TARGET}" --strip-components 1

export PATH="${BOSH_INSTALL_TARGET}/bin:${PATH}"

# Installs missing plugins
logstash-plugin install "file://${PWD}/logstash/logstash-filter-alter-3.0.2.zip"
logstash-plugin install "file://${PWD}/logstash/logstash-input-relp-3.0.2.zip"
logstash-plugin install "file://${PWD}/logstash/logstash-filter-translate-3.0.3.zip"
logstash-plugin install "file://${PWD}/logstash/logstash-input-syslog-3.2.2.zip"
logstash-plugin install "file://${PWD}/logstash/logstash-output-syslog-3.0.5.zip"
